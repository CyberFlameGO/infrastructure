FROM ruby:2.1.10

# Install shared packages
RUN apt-get update && apt-get install -y \
  software-properties-common \
  python-software-properties \
  apt-transport-https

# Universal git variables
ARG GIT_USER=StratusNetwork
ARG GIT_BRANCH_PRODUCTION=master
ARG GIT_BRANCH_TEST=staging
ARG GIT_CACHE=false
ARG GIT_REMOTE=true
ARG GIT_EMAIL=$GIT_USER@github.com
ARG GIT_NAME=$GIT_USER

# Convert git build args to environment variables
# This allows child Dockerfiles to access them
ENV GIT_USER=$GIT_USER
ENV GIT_BRANCH_PRODUCTION=$GIT_BRANCH_PRODUCTION
ENV GIT_BRANCH_TEST=$GIT_BRANCH_TEST
ENV GIT_CACHE=$GIT_CACHE
ENV GIT_REMOTE=$GIT_REMOTE
ENV GIT_EMAIL=$GIT_EMAIL
ENV GIT_NAME=$GIT_NAME

# Install and setup git
RUN git config --global user.email $GIT_EMAIL
RUN git config --global user.name $GIT_NAME

# Create build directory
WORKDIR build

# Copy local development builds (only used when GIT_REMOTE=false)
COPY build ./local

# Copy git cloning script
COPY script/clone.sh ./clone.sh
RUN chmod +x clone.sh
